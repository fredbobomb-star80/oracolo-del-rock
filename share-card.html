<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Carta condivisibile - Oracolo del Rock</title>

  <!-- Font calligrafico, come la cabina -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cinzel&display=swap">

  <style>
    body{
      margin:0;
      padding:0;
      background:#000;
      color:#eee;
      font-family:system-ui,Arial,sans-serif;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
    }

    /* Contenitore proporzionato 1080x1350 (scalato sullo schermo) */
    .card-wrapper{
      width:min(90vw, 540px);
      aspect-ratio:1080/1350;
      position:relative;
      overflow:hidden;
      box-shadow:
        0 18px 40px rgba(0,0,0,0.9),
        0 0 20px rgba(0,0,0,0.8);
    }

    .card-wrapper img{
      width:100%;
      height:100%;
      display:block;
      object-fit:cover;
    }

    /* TESTO RISPOSTA â€“ posizione approvata */
    .card-text{
      position:absolute;
      bottom:38%;
      left:50%;
      transform:translateX(-50%);
      width:75%;
      text-align:center;
      font-family:"Cinzel", serif;

      font-size: clamp(14px, 3.2vw, 24px);
      line-height: 1.2;
      overflow-wrap: break-word;
      
      color:#fffdf5;

      text-shadow:
        0 0 3px rgba(0,0,0,0.9),
        0 0 6px rgba(0,0,0,0.9),
        0 0 18px rgba(255,105,180,0.75);
    }

    /* NUMERO RISPOSTA â€“ RISPOSTA N:000 */
    .card-number{
      position:absolute;
      bottom:10%;
      left:50%;
      transform:translateX(-50%);
      font-size:0.6rem;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:#f5f5f5;
      text-shadow:
        0 0 4px rgba(0,0,0,0.9),
        0 0 10px rgba(0,0,0,0.8);
      background:rgba(0,0,0,0.45);
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.25);
    }

    .debug-note{
      position:fixed;
      bottom:6px;
      left:50%;
      transform:translateX(-50%);
      font-size:10px;
      opacity:0.5;
      font-family:system-ui,Arial,sans-serif;
    }
  </style>
</head>

<body>

  <div class="card-wrapper" id="card-wrapper">
    <!-- âš ï¸ AGGIUNTO id="card-image" -->
    <img id="card-image" src="card-template.png" alt="Carta Oracolo del Rock">

    <div class="card-text" id="card-text">
      questa Ã¨ una frase di prova per verificare il font
    </div>

    <div class="card-number" id="card-number">
      RISPOSTA N:000
    </div>
  </div>

  <div class="debug-note" id="debug-note">
    Generazione immagine in corso...
  </div>

  <!-- html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    (function(){
      const params = new URLSearchParams(window.location.search);

      /* ------------------------------
         ðŸŽ¸ LISTA VARIANTI DELLA CARTA
         ------------------------------ */
      const cardVariants = [
        "card-template.png",
        "card-template-bullet.png",
        "card-template-lipstick.png",
        "card-template-burned.png"
      ];

      /* ---------------------------------------------------
         ðŸŽ¸ SCEGLIE A CASO UNA CARTA PRIMA DELLA GENERAZIONE
         --------------------------------------------------- */
      const cardImg = document.getElementById("card-image");
      if (cardImg){
        const randomIndex = Math.floor(Math.random() * cardVariants.length);
        cardImg.src = cardVariants[randomIndex];
      }

      const rawText = params.get("text");
      const rawNum  = params.get("n");

      const textEl  = document.getElementById("card-text");
      const numEl   = document.getElementById("card-number");
      const wrapper = document.getElementById("card-wrapper");
      const debugEl = document.getElementById("debug-note");

      let paddedNum = "000";

      if (rawText && textEl){
        const decoded = decodeURIComponent(rawText.replace(/\+/g, " "));
        textEl.textContent = decoded;
      }

      if (rawNum && numEl){
        const n = parseInt(rawNum, 10);
        if (!isNaN(n) && n > 0){
          paddedNum = String(n).padStart(3, "0");
          numEl.textContent = "RISPOSTA N:" + paddedNum;
        }
      }

      window.addEventListener("load", () => {
        setTimeout(() => {
          generaECondividi(wrapper, paddedNum, textEl?.textContent || "", debugEl);
        }, 400);
      });

      async function generaECondividi(wrapper, numeroFormattato, frase, debugEl){
        if (!wrapper){
          if (debugEl) debugEl.textContent = "Errore: card-wrapper non trovato.";
          return;
        }

        if (debugEl) debugEl.textContent = "Creo l'immagine della carta...";

        try{
          const canvas = await html2canvas(wrapper, {
            useCORS: true,
            backgroundColor: null,
            scale: 2
          });

          if (debugEl) debugEl.textContent = "Preparo il file per la condivisione...";

          canvas.toBlob(async (blob) => {
            if (!blob){
              if (debugEl) debugEl.textContent = "Impossibile creare il blob.";
              return;
            }

            const fileName = "oracolo-risposta-" + numeroFormattato + ".png";
            const file = new File([blob], fileName, { type: "image/png" });

            const shareData = {
              files: [file],
              title: "Chiedilo allâ€™Oracolo del Rock",
              text: frase ? ("La mia carta dell'Oracolo del Rock:\n\n" + frase) : "La mia carta dell'Oracolo del Rock"
            };

            if (navigator.canShare && navigator.canShare({ files: [file] })){
              try{
                if (debugEl) debugEl.textContent = "Apro il menu di condivisione...";
                await navigator.share(shareData);
                return;
              }catch(err){
                apriPngInNuovaScheda(canvas);
                return;
              }
            }else{
              apriPngInNuovaScheda(canvas);
            }
          }, "image/png");
        }catch(err){
          if (debugEl) debugEl.textContent = "Errore nella generazione.";
        }
      }

      function apriPngInNuovaScheda(canvas){
        const dataUrl = canvas.toDataURL("image/png");
        const w = window.open();
        if (w){
          w.document.write(
            "<!doctype html><html><head><title>Carta Oracolo</title></head><body style='margin:0;background:#000;display:flex;align-items:center;justify-content:center;min-height:100vh;'>" +
            "<img src='" + dataUrl + "' style='max-width:100%;height:auto;display:block;' />" +
            "</body></html>"
          );
        }
      }
    })();
  </script>

</body>
</html>
