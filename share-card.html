<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Carta condivisibile - Oracolo del Rock</title>

  <!-- Font identico al sito -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative&display=swap">

  <style>
    body{
      margin:0;
      padding:0;
      background:#000;
      color:#eee;
      font-family:system-ui,Arial,sans-serif;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
    }

    /* Contenitore proporzionato 1080x1350 (scalato sullo schermo) */
    .card-wrapper{
      width:min(90vw, 540px);
      aspect-ratio:1080/1350;
      position:relative;
      overflow:hidden;
      box-shadow:
        0 18px 40px rgba(0,0,0,0.9),
        0 0 20px rgba(0,0,0,0.8);
    }

    .card-wrapper img{
      width:100%;
      height:100%;
      display:block;
      object-fit:cover;
    }

    /* TESTO RISPOSTA – clone di .oracle-text */
    .card-text{
      position:absolute;
      bottom:37%;          /* equivalente visivo del top:70% sulla cabina */
      left:50%;
      transform:translateX(-50%);
      width:80%;
      color:#fffdf5;

      /* AUTO-RESIZE TESTO */
      font-size: clamp(14px, 4vw, 26px);
      overflow-wrap: break-word;
      line-height:1.25;
      text-align:center;

      font-family:"Cinzel Decorative", serif;
      font-weight:400;
      letter-spacing:0.03em;

      /* --- CONTORNO NETTO + GLOW --- */
      text-shadow:
        -2px -2px 0 #000,
         2px -2px 0 #000,
        -2px  2px 0 #000,
         2px  2px 0 #000,
        0 2px 3px rgba(0,0,0,0.6),
        0 0 8px rgba(255,105,180,0.35);
    }

    /* OGNI PAROLA È UN BLOCCO, COSÌ NON SI SPEZZA (clone) */
    .card-text .word{
      display:inline-block;
    }

    /* INIZIALI PIÙ GRANDI MA BILANCIATE (clone di .big-init) */
    .card-text .big-init{
      font-size:1.6em;
      line-height:0.9;
      display:inline-block;
      vertical-align:-6%;
      padding-right:1px;
    }

    /* NUMERO RISPOSTA – badge premium */
    .card-number{
      position:absolute;
      bottom:11%;
      left:50%;
      transform:translateX(-50%);
      font-size:0.7rem;
      letter-spacing:0.18em;
      text-transform:uppercase;

      color:#f5f5f5;
      text-shadow:
        0 0 4px rgba(0,0,0,0.95),
        0 0 10px rgba(0,0,0,0.85);

      background:rgba(0,0,0,0.55);
      padding:5px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.35);
    }

    .debug-note{
      position:fixed;
      bottom:6px;
      left:50%;
      transform:translateX(-50%);
      font-size:10px;
      opacity:0.5;
      font-family:system-ui,Arial,sans-serif;
    }
  </style>
</head>

<body>

  <div class="card-wrapper" id="card-wrapper">
    <img id="card-image" src="card-template.png" alt="Carta Oracolo del Rock">

    <div class="card-text" id="card-text">
      <!-- verrà riempito via JS con gli span .word / .big-init -->
    </div>

    <div class="card-number" id="card-number">
      RISPOSTA N:000
    </div>
  </div>

  <div class="debug-note" id="debug-note">
    Generazione immagine in corso...
  </div>

  <!-- html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    (function(){
      const params = new URLSearchParams(window.location.search);

      const rawText = params.get("text");
      const rawNum  = params.get("n");

      const textEl  = document.getElementById("card-text");
      const numEl   = document.getElementById("card-number");
      const wrapper = document.getElementById("card-wrapper");
      const debugEl = document.getElementById("debug-note");

      let paddedNum = "000";

      // === clone di formatOracleText dal sito ===
      function formatOracleText(testo){
        if(!testo) return "";
        const words = testo.trim().split(/\s+/);

        return words.map(word => {
          const first = word.charAt(0).toUpperCase();
          const rest  = word.slice(1);
          return `<span class="word"><span class="big-init">${first}</span>${rest}</span>`;
        }).join(" ");
      }

      if (rawText && textEl){
        const decoded = decodeURIComponent(rawText.replace(/\+/g, " "));
        textEl.innerHTML = formatOracleText(decoded);
      }

      if (rawNum && numEl){
        const n = parseInt(rawNum, 10);
        if (!isNaN(n) && n > 0){
          paddedNum = String(n).padStart(3, "0");
          numEl.textContent = "RISPOSTA N:" + paddedNum;
        }
      }

      window.addEventListener("load", () => {
        setTimeout(() => {
          generaECondividi(wrapper, paddedNum, textEl?.textContent || "", debugEl);
        }, 400);
      });

      async function generaECondividi(wrapper, numeroFormattato, frase, debugEl){
        if (!wrapper){
          if (debugEl) debugEl.textContent = "Errore: card-wrapper non trovato.";
          return;
        }

        if (debugEl) debugEl.textContent = "Creo l'immagine della carta...";

        try{
          const canvas = await html2canvas(wrapper, {
            useCORS: true,
            backgroundColor: null,
            scale: 2
          });

          if (debugEl) debugEl.textContent = "Preparo il file per la condivisione...";

          canvas.toBlob(async (blob) => {
            if (!blob){
              if (debugEl) debugEl.textContent = "Impossibile creare il blob.";
              return;
            }

            const fileName = "oracolo-risposta-" + numeroFormattato + ".png";
            const file = new File([blob], fileName, { type: "image/png" });

            const shareData = {
              files: [file],
              title: "Chiedilo all’Oracolo del Rock",
              text: frase ? ("La mia carta dell'Oracolo del Rock:\n\n" + frase) : "La mia carta dell'Oracolo del Rock"
            };

            if (navigator.canShare && navigator.canShare({ files: [file] })){
              try{
                if (debugEl) debugEl.textContent = "Apro il menu di condivisione...";
                await navigator.share(shareData);
                return;
              }catch(err){
                apriPngInNuovaScheda(canvas);
                return;
              }
            }else{
              apriPngInNuovaScheda(canvas);
            }
          }, "image/png");
        }catch(err){
          if (debugEl) debugEl.textContent = "Errore nella generazione.";
        }
      }

      function apriPngInNuovaScheda(canvas){
        const dataUrl = canvas.toDataURL("image/png");
        const w = window.open();
        if (w){
          w.document.write(
            "<!doctype html><html><head><title>Carta Oracolo</title></head><body style='margin:0;background:#000;display:flex;align-items:center;justify-content:center;min-height:100vh;'>" +
            "<img src='" + dataUrl + "' style='max-width:100%;height:auto;display:block;' />" +
            "</body></html>"
          );
        }
      }
    })();
  </script>

</body>
</html>
