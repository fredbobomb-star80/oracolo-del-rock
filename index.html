<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chiedilo all’Oracolo del Rock</title>

  <style>
    /* ============================
       ***   MIO CSS   ***
       Qui dentro c’è tutto lo stile del sito
       ============================ */
    
    body{
      margin:0;
      background:#0b0b0f;
      color:#eee;
      font-family:system-ui,Arial,sans-serif;
      text-align:center;
    }

    /* CABINA */
    .hero{
      width:100%;
      max-width:980px;
      margin:0 auto;
      position:relative;
      display:flex;
      justify-content:center;
      padding-top:10px;
    }
    .hero-img{
      width:100%;
      height:auto;
      display:block;
      /* stato normale: nessuna animazione */
    }

    /* --- EFFETTO 2+3: MICRO-VIBRAZIONE NEON + ACCENSIONE --- */
    /* quando l'oracolo si "attiva", aggiungiamo la classe .activating alla hero-img */
    .hero-img.activating{
      /* due animazioni in parallelo:
         - heroShake: micro-vibrazione continua
         - powerOn: accensione progressiva della cabina */
      animation:
        heroShake 0.16s infinite alternate,
        powerOn 2.6s ease-out forwards; /* << durata aumentata */
      transform-origin:center;
      filter: brightness(0.6); /* parte leggermente scura */
    }

    /* micro movimento, molto leggero per non dare fastidio all'occhio */
    @keyframes heroShake{
      from{
        transform: translate(0px, 0px);
        /* nessun filter qui, lo gestisce powerOn */
      }
      to{
        transform: translate(0.7px, -0.7px);
        /* niente filter per evitare conflitti */
      }
    }

    /* ACCENSIONE della cabina dell'oracolo (dark + flash) */
    @keyframes powerOn{
      0%{
        filter: brightness(0.4) contrast(0.9);
      }
      40%{
        filter: brightness(0.7) contrast(1.1);
      }
      65%{
        filter: brightness(1.1) saturate(1.2);
      }
      100%{
        filter: brightness(1) contrast(1);
      }
    }

    /* AREA VIDEO */

    /* ---- FADE IN/OUT VIDEO ---- */
    .yt-overlay.is-hidden{
      opacity: 0;
      transform: translateY(6px);
      transition: opacity .6s ease, transform .6s ease;
      pointer-events: none;
    }

    .yt-overlay.is-visible{
      opacity: 1;
      transform: translateY(0);
      transition: opacity .6s ease, transform .6s ease;
      pointer-events: auto;
    }

    /* ---- EFFETTO DI ENTRATA (AUDIO SUBITO, VIDEO DOPO 3s) ---- */
    .yt-overlay.is-visible.audio-first{
      opacity: 0;
      transform: translateY(6px);
      pointer-events: none;
    }
    
    .yt-overlay{
      position:absolute;
      left:41%;
      top:80%;
      width:15%;
      height:12%;

      display:flex;
      align-items:center;
      justify-content:center;

      background:rgba(0,0,0,0.25);
      border-radius:14px;
      padding:4px;
      box-shadow:0 0 10px rgba(0,0,0,0.6);
      backdrop-filter: blur(2px);
      overflow:hidden;
    }

    .yt-overlay iframe{
      width:100%;
      height:100%;
      border-radius:10px;
      border:2px solid rgba(0,200,255,0.6);
      box-shadow:0 0 12px rgba(0,200,255,0.35);
    }

    /* BOTTONE PRINCIPALE */
    .frame-button{
      position:absolute;
      top:102%;
      left:50%;
      transform:translateX(-50%);
    }

    #new{
      background: linear-gradient(180deg, #0fe3ff 0%, #00a9d6 45%, #006b8a 100%);
      color:#001018;
      border: 2px solid rgba(0,200,255,0.9);
      padding:13px 26px;
      font-size:15px;
      border-radius:999px;
      font-weight:1000;
      cursor:pointer;
      letter-spacing:1px;

      box-shadow:
        0 6px 16px rgba(0,0,0,0.8),
        inset 0 2px 0 rgba(255,255,255,0.35),
        inset 0 -3px 8px rgba(0,0,0,0.6),
        0 0 14px rgba(0,200,255,0.65),
        0 0 30px rgba(0,200,255,0.35);

      transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
    }

    #new:hover{
      transform: translateY(-1px) scale(1.02);
      filter: brightness(1.12) saturate(1.1);
      box-shadow:
        0 8px 18px rgba(0,0,0,0.85),
        inset 0 2px 0 rgba(255,255,255,0.45),
        inset 0 -3px 10px rgba(0,0,0,0.7),
        0 0 18px rgba(0,200,255,0.9),
        0 0 42px rgba(0,200,255,0.55);
    }

    #new:active{
      transform: translateY(1px) scale(0.99);
      filter: brightness(0.98);
      box-shadow:
        0 3px 10px rgba(0,0,0,0.9),
        inset 0 3px 8px rgba(0,0,0,0.8),
        0 0 10px rgba(0,200,255,0.6);
    }

    /* --- STATO "ACCENSIONE" DEL BOTTONE (prima che l'oracolo sia pronto) --- */
    #new.disabled{
      opacity:0.5;
      pointer-events:none;
      filter:grayscale(90%);
      animation: btnPulse 1s infinite alternate;
    }

    @keyframes btnPulse{
      from{
        box-shadow:
          0 4px 10px rgba(0,0,0,0.7),
          0 0 10px rgba(0,200,255,0.25);
      }
      to{
        box-shadow:
          0 6px 18px rgba(0,0,0,0.85),
          0 0 18px rgba(0,200,255,0.8);
      }
    }

    /* SOTTO CABINA */
    .wrap{
      max-width:920px;
      margin:0 auto;
      padding:16px 16px 40px;
      margin-top:60px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    /* SOCIAL */
    .social-buttons{
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top:30px;
    }

    .social-btn{
      text-decoration:none;
      color:#ddd;
      background:#1a1a1a;
      border:2px solid #ff3ccf;
      padding:4px 10px;
      font-size:12px;
      border-radius:999px;
      font-weight:700;
      display:flex;
      align-items:center;
      gap:6px;
      transition:all .2s ease;
      box-shadow:0 0 8px rgba(255,60,207,.2);
    }

    .social-btn:hover{
      transform:scale(1.05);
      color:#fff;
    }

    .social-btn.youtube:hover{ background:#ff0000; border-color:#ff0000; }
    .social-btn.facebook:hover{ background:#1877f2; border-color:#1877f2; }
    .social-btn.instagram:hover{ background:#e4405f; border-color:#e4405f; }

    .note{ font-size:13px; opacity:.7; }
  </style>
</head>

<body>

  <!-- CABINA ORACOLO -->
  <header class="hero">
    <img 
      src="https://raw.githubusercontent.com/fredbobomb-star80/oracolo-del-rock/main/214417.png"
      alt="Chiedilo all’Oracolo del Rock"
      class="hero-img"
    />

    <!-- SCATOLA CONTENITRICE DEL VIDEO / Partenza invisibile e dissolvenza alla fine -->
    <div id="yt" class="yt-overlay is-hidden"></div>

    <!-- BOTTONE -->
    <div class="frame-button">
      <button id="new">PESCA LA TUA CARTA</button>
    </div>
  </header>

  <!-- SOTTO CABINA -->
  <main class="wrap">
    <div class="social-buttons">
      <a href="https://www.youtube.com/watch?v=YdEggax27GA&list=PL5l5Dspe3Obumt-dqGDVzM4bHp5Qc_vVx" target="_blank" class="social-btn youtube">YouTube</a>
      <a href="https://www.facebook.com/profile.php?id=61583198656003" target="_blank" class="social-btn facebook">Facebook</a>
      <a href="https://www.instagram.com/chiedilo_all_oracolo_del_rock" target="_blank" class="social-btn instagram">Instagram</a>
    </div>

    <p class="note">L'oracolo custodisce 666 risposte e solo una è destinata a te. Da un’idea originale di FredBee — tutti i diritti riservati ©2025</p>
  </main>

  <!-- SCRIPT YOUTUBE -->
  <script>
    const API_KEY     = "AIzaSyDNsQKEvKwHOyZCJ0mojJS325Sbw6wX9as";
    const PLAYLIST_ID = "PL5l5Dspe3Obumt-dqGDVzM4bHp5Qc_vVx";
    const PAGE_SIZE   = 50;

    (function(){
      const s = document.createElement('script');
      s.src = "https://www.youtube.com/iframe_api";
      document.head.appendChild(s);
    })();

    let player = null;
    let allIds = [];
    let entranceTimer = null;

    // watcher per uscita pro (fade-out prima della fine)
    let outroInterval = null;
    let outroTriggered = false;

    // YouTube chiama questa quando la Iframe API è pronta
    window.onYouTubeIframeAPIReady = () => {
      player = new YT.Player('yt', {
        height: '390',
        width:  '640',
        playerVars: { modestbranding: 1, rel: 0 },
        events: {
          onReady: onReady,
          onStateChange: onStateChange
        }
      });
    };

    function onReady(){
      const btn    = document.getElementById("new");
      const heroImg = document.querySelector(".hero-img");

      /* --- FASE 1: appena carichi la pagina, l'oracolo si "accende" --- */
      btn.classList.add("disabled");
      btn.textContent = "ACCENSIONE DELL'ORACOLO...";

      // attiva vibrazione + accensione cabina
      if(heroImg){
        heroImg.classList.add("activating");
      }

      /* --- Prepariamo il click --- */
      btn.addEventListener("click", playRandom);

      /* --- Avviamo il caricamento della playlist YouTube --- */
      boot();
    }

    async function boot(){
      try{
        // Scarica TUTTI gli ID della playlist
        allIds = await fetchAllPlaylistIds(PLAYLIST_ID);
      }catch(err){
        console.error(err);
        alert("Errore nel caricare la playlist.");
      }

      /* --- FASE 2: oracolo pronto → bottone normale e cliccabile --- */
      const btn     = document.getElementById("new");
      const heroImg = document.querySelector(".hero-img");

      btn.classList.remove("disabled");
      btn.textContent = "PESCA LA TUA CARTA";

      // spegni animazione cabina
      if(heroImg){
        heroImg.classList.remove("activating");
      }
    }

    async function fetchAllPlaylistIds(playlistId){
      let ids = [];
      let pageToken = "";

      do{
        const url = new URL("https://www.googleapis.com/youtube/v3/playlistItems");
        url.searchParams.set("key", API_KEY);
        url.searchParams.set("part", "snippet");
        url.searchParams.set("playlistId", playlistId);
        url.searchParams.set("maxResults", PAGE_SIZE);
        if(pageToken) url.searchParams.set("pageToken", pageToken);

        const res = await fetch(url.toString());
        if(!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        const batch = (data.items || [])
          .map(i => i?.snippet?.resourceId?.videoId)
          .filter(Boolean);

        ids.push(...batch);
        pageToken = data.nextPageToken || "";

      } while(pageToken);

      return [...new Set(ids)];
    }

    function playRandom(){
      const btn = document.getElementById("new");
      if(btn.classList.contains("disabled")) return;

      if(!player || !allIds.length) return;

      const ytBox = document.getElementById("yt");

      if(entranceTimer){
        clearTimeout(entranceTimer);
        entranceTimer = null;
      }

      clearOutroWatcher();
      outroTriggered = false;

      ytBox.classList.remove("is-hidden");
      ytBox.classList.add("is-visible");
      ytBox.classList.add("audio-first");

      const idx = Math.floor(Math.random() * allIds.length);
      const id  = allIds[idx];

      player.loadVideoById(id);

      entranceTimer = setTimeout(() => {
        ytBox.classList.remove("audio-first");
        entranceTimer = null;
      }, 3000);
    }

    function onStateChange(e){
      const ytBox = document.getElementById("yt");

      if(e.data === YT.PlayerState.PLAYING){
        startOutroWatcher();
      }

      if(
        e.data === YT.PlayerState.PAUSED ||
        e.data === YT.PlayerState.BUFFERING
      ){
        clearOutroWatcher();
      }

      if(e.data === YT.PlayerState.ENDED){
        clearOutroWatcher();
        outroTriggered = false;

        if(entranceTimer){
          clearTimeout(entranceTimer);
          entranceTimer = null;
        }
        ytBox.classList.remove("audio-first");

        ytBox.classList.remove("is-visible");
        ytBox.classList.add("is-hidden");
      }
    }

    // ---- USCITA PRO PRIMA DELLA FINE ----
    function startOutroWatcher(){
      clearOutroWatcher();
      outroTriggered = false;

      outroInterval = setInterval(() => {
        if(!player || outroTriggered) return;

        const dur = player.getDuration();
        const cur = player.getCurrentTime();

        if(!dur || !cur) return;

        const remaining = dur - cur;

        if(remaining <= 1.0){
          outroTriggered = true;
          triggerOutro();
        }
      }, 250);
    }

    function clearOutroWatcher(){
      if(outroInterval){
        clearInterval(outroInterval);
        outroInterval = null;
      }
    }

    function triggerOutro(){
      const ytBox = document.getElementById("yt");

      ytBox.classList.remove("is-visible");
      ytBox.classList.add("is-hidden");

      setTimeout(() => {
        try{ player.stopVideo(); }catch(_){}
      }, 200);

      clearOutroWatcher();
    }
  </script>

</body>
</html>
