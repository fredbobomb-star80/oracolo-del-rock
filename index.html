<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chiedilo all‚ÄôOracolo del Rock</title>

  <!-- Font calligrafico per il testo carta -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative&display=swap">

  <style>
    body{
      margin:0;
      background:#0b0b0f;
      color:#eee;
      font-family:system-ui,Arial,sans-serif;
      text-align:center;
    }

    /* CABINA */
    .hero{
      width:100%;
      max-width:980px;
      margin:0 auto;
      position:relative;
      display:flex;
      justify-content:center;
      padding-top:10px;
    }
    .hero-img{
      width:100%;
      height:auto;
      display:block;
    }

    /* ANIMAZIONE CABINA */
    .hero-img.activating{
      animation:
        heroShake 0.16s infinite alternate,
        powerOnFlash 1.7s ease-out forwards;
      transform-origin:center;
    }

    @keyframes heroShake{
      from{ transform: translate(0px, 0px); }
      to{   transform: translate(0.7px, -0.7px); }
    }

    @keyframes powerOnFlash{
      0%  { opacity:0; filter:brightness(0.3) contrast(0.8); }
      50% { opacity:1; filter:brightness(0.8) contrast(1.1); }
      70% { opacity:0; filter:brightness(0.4) contrast(1);   }
      85% { opacity:1; filter:brightness(1.4) saturate(1.6); }
      100%{ opacity:1; filter:brightness(1) contrast(1);      }
    }

    /* AREA VIDEO */
    .yt-overlay.is-hidden{
      opacity: 0;
      transform: translateY(6px);
      transition: opacity .6s ease, transform .6s ease;
      pointer-events: none;
    }

    .yt-overlay.is-visible{
      opacity: 1;
      transform: translateY(0);
      transition: opacity .6s ease, transform .6s ease;
      pointer-events: auto;
    }

    .yt-overlay.is-visible.audio-first{
      opacity: 0;
      transform: translateY(6px);
      pointer-events: none;
    }

    .yt-overlay.is-visible.audio-first iframe{
      visibility: hidden;
    }

    .yt-overlay{
      position:absolute;
      left:41%;
      top:80%;
      width:15%;
      height:12%;
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,0.25);
      border-radius:14px;
      padding:4px;
      box-shadow:0 0 10px rgba(0,0,0,0.6);
      backdrop-filter: blur(2px);
      overflow:hidden;
    }

    .yt-overlay iframe{
      width:100%;
      height:100%;
      border-radius:10px;
      border:2px solid rgba(0,200,255,0.6);
      box-shadow:0 0 12px rgba(0,200,255,0.35);
    }

    /* SEZIONE AZIONI SOTTO LA CABINA */
    .actions{
      margin-top:14px;
    }

    /* SPAZIO TRA I PULSANTI CONDIVIDI ED IL TASTO PESCA LA TUA CARTA */
    .share-row{
      text-align:center;
      margin-bottom:0px;
    }

    .share-btn{
      display:inline-block;
      padding:6px 14px;
      margin:0 4px;
      border-radius:999px;
      border:2px solid #ff00ff;
      background:#000;
      color:#fff;
      font-size:13px;
      font-weight:500;
      letter-spacing:0.03em;
      cursor:pointer;
      box-shadow:0 0 8px rgba(255,60,207,.2);
    }

    .share-btn-off{
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
      filter: grayscale(60%);
      pointer-events: none;
    }

    #new{
      background: linear-gradient(180deg, #0fe3ff 0%, #00a9d6 45%, #006b8a 100%);
      color:#001018;
      border: 2px solid rgba(0,200,255,0.9);
      padding:13px 26px;
      font-size:15px;
      border-radius:999px;
      font-weight:1000;
      cursor:pointer;
      letter-spacing:1px;
      box-shadow:
        0 6px 16px rgba(0,0,0,0.8),
        inset 0 2px 0 rgba(255,255,255,0.35),
        inset 0 -3px 8px rgba(0,0,0,0.6),
        0 0 14px rgba(0,200,255,0.65),
        0 0 30px rgba(0,200,255,0.35);
      transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
      margin-top: 20px;
    }

    #new:hover{
      transform: translateY(-1px) scale(1.02);
      filter: brightness(1.12) saturate(1.1);
      box-shadow:
        0 8px 18px rgba(0,0,0,0.85),
        inset 0 2px 0 rgba(255,255,255,0.45),
        inset 0 -3px 10px rgba(0,0,0,0.7),
        0 0 18px rgba(0,200,255,0.9),
        0 0 42px rgba(0,200,255,0.55);
    }

    #new:active{
      transform: translateY(1px) scale(0.99);
      filter: brightness(0.98);
      box-shadow:
        0 3px 10px rgba(0,0,0,0.9),
        inset 0 3px 8px rgba(0,0,0,0.8),
        0 0 10px rgba(0,200,255,0.6);
    }

    #new.disabled{
      opacity:0.5;
      pointer-events:none;
      filter:grayscale(90%);
      animation: btnPulse 1s infinite alternate;
    }

    @keyframes btnPulse{
      from{
        box-shadow:
          0 4px 10px rgba(0,0,0,0.7),
          0 0 10px rgba(0,200,255,0.25);
      }
      to{
        box-shadow:
          0 6px 18px rgba(0,0,0,0.85),
          0 0 18px rgba(0,200,255,0.8);
      }
    }

    .wrap{
      max-width:920px;
      margin:0 auto;
      padding:18px 16px 40px;
      margin-top:-1px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .social-buttons{
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top:2px;
    }

    .social-btn{
      text-decoration:none;
      color:#ddd;
      background:#1a1a1a;
      border:2px solid #ff3ccf;
      padding:4px 10px;
      font-size:12px;
      border-radius:999px;
      font-weight:700;
      display:flex;
      align-items:center;
      gap:6px;
      transition:all .2s ease;
      box-shadow:0 0 8px rgba(255,60,207,.2);
    }

    .social-btn:hover{
      transform:scale(1.05);
      color:#fff;
    }

    .social-btn.youtube:hover{ background:#ff0000; border-color:#ff0000; }
    .social-btn.facebook:hover{ background:#1877f2; border-color:#1877f2; }
    .social-btn.instagram:hover{ background:#e4405f; border-color:#e4405f; }

    .note{
      font-size:13px;
      opacity:.7;
      margin-top:-6px;
    }

    /* TESTO NELLA CABINA */
    .oracle-text{
      position:absolute;
      top:70%;
      left:50%;
      transform:translate(-50%, -50%);
      width:80%;
      color:#fffdf5;

      font-size: clamp(14px, 4vw, 26px);
      overflow-wrap: break-word;
      line-height:1.25;
      text-align:center;

      font-family:"Cinzel Decorative", serif;
      font-weight:400;
      letter-spacing:0.03em;

      text-shadow:
        -2px -2px 0 #000,
         2px -2px 0 #000,
        -2px  2px 0 #000,
         2px  2px 0 #000,
        0 2px 3px rgba(0,0,0,0.6),
        0 0 8px rgba(255,105,180,0.35);

      opacity:0;
      transition:opacity .6s ease;
    }

    .oracle-text.visible{
      opacity:1;
    }

    .oracle-text .word{
      display:inline-block;
    }

    .oracle-text .big-init{
      font-size:1.6em;
      line-height:0.9;
      display:inline-block;
      vertical-align:-6%;
      padding-right:1px;
    }

    /* ============ OVERLAY CONDIVISIONE CARTA ============ */

    .card-share-overlay{
      position:fixed;
      inset:0;
      background:#0b0b0f; /* stesso sfondo del sito */
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
    }

    .card-share-panel{
      max-width:480px;
      width:90%;
      background:#000;
      border-radius:18px;
      box-shadow:0 18px 40px rgba(0,0,0,0.9);
      padding:14px 14px 16px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .card-share-header{
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      margin-bottom:4px;
    }

    .card-share-title{
      font-size:14px;
      letter-spacing:0.08em;
      text-transform:uppercase;
      color:#f5f5f5;
    }

    .card-share-close{
      position:absolute;
      left:0;
      top:50%;
      transform:translateY(-50%);
      background:none;
      border:none;
      color:#f5f5f5;
      font-size:18px;
      cursor:pointer;
    }

    .card-share-preview-wrap{
      background:#050505;
      border-radius:12px;
      padding:10px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .card-share-preview{
      max-width:100%;
      height:auto;
      display:block;
      border-radius:10px;
    }

    .card-share-actions{
      margin-top:4px;
      display:flex;
      gap:8px;
      justify-content:center;
      flex-wrap:wrap;
    }

    /* generatore nascosto per la carta */
    .share-card-generator{
      position:absolute;
      left:-9999px;
      top:-9999px;
    }

    .share-card-generator .card-wrapper{
      width:1080px;
      height:1350px;
      position:relative;
      overflow:hidden;
    }

    .share-card-generator .card-wrapper img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    .share-card-generator .card-text{
      position:absolute;
      bottom:40%;
      left:50%;
      transform:translateX(-50%);
      width:52%;
      color:#fffdf5;

      font-size: 40px; /*  fisso di nuovo a 40px fisso */
      overflow-wrap: break-word;
      line-height:1.25;
      text-align:center;

      font-family:"Cinzel Decorative", serif;
      font-weight:400;
      letter-spacing:0.03em;


      text-shadow:
        -2px -2px 0 #000,
         2px -2px 0 #000,
        -2px  2px 0 #000,
         2px  2px 0 #000,
        0 2px 3px rgba(0,0,0,0.6),
        0 0 8px rgba(255,105,180,0.35);

    }

    .share-card-generator .card-text .word{
      display:inline-block;
    }

    .share-card-generator .card-text .big-init{
      font-size:1.6em;
      line-height:0.9;
      display:inline-block;
      vertical-align:-6%;
      padding-right:1px;
    }

    .share-card-generator .card-number{
      position:absolute;
      bottom:11%;
      left:50%;
      transform:translateX(-50%);
      margin-bottom:8px; /* <-- NUOVO, alza la scritta di 8px */
      font-size:30px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:#f5f5f5;
      text-shadow:
        0 0 4px rgba(0,0,0,0.95),
        0 0 10px rgba(0,0,0,0.85);
      background:rgba(0,0,0,0.55);
      padding:10px 28px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.35);
    }

  </style>
</head>

<body>

  <!-- CABINA ORACOLO -->
  <header class="hero">
    <img 
      src="https://raw.githubusercontent.com/fredbobomb-star80/oracolo-del-rock/main/214417.png"
      alt="Chiedilo all‚ÄôOracolo del Rock"
      class="hero-img"
    />

    <!-- TESTO ORACOLO -->
    <div id="oracle-text" class="oracle-text"></div>

    <!-- SCATOLA CONTENITRICE DEL VIDEO -->
    <div id="yt" class="yt-overlay is-hidden"></div>
  </header>

  <!-- AZIONI SOTTO LA CABINA -->
  <section class="actions">
    <div class="share-row">
      <button class="share-btn" id="share-audio">
        üéµ Condividi üéµ
      </button>
      <button class="share-btn" id="share-card">
        ‚úçÔ∏è Condividi ‚úçÔ∏è
      </button>
    </div>

    <button id="new">PESCA LA TUA CARTA</button>
  </section>

  <!-- SOTTO CABINA: SOCIAL + TESTO -->
  <main class="wrap">
    <div class="social-buttons">
      <a href="https://www.youtube.com/watch?v=YdEggax27GA&list=PL5l5Dspe3Obumt-dqGDVzM4bHp5Qc_vVx" target="_blank" class="social-btn youtube">YouTube</a>
      <a href="https://www.facebook.com/profile.php?id=61583198656003" target="_blank" class="social-btn facebook">Facebook</a>
      <a href="https://www.instagram.com/chiedilo_all_oracolo_del_rock" target="_blank" class="social-btn instagram">Instagram</a>
    </div>

 <p class="note">Chiedilo all'Oracolo del Rock custodisce 666 brani ma solo uno √® destinato a te. FredBee's Tutti i diritti riservati ¬©2025</p>
</main>

  <!-- OVERLAY CONDIVISIONE CARTA -->
  <div id="card-share-overlay" class="card-share-overlay">
    <div class="card-share-panel">
      <div class="card-share-header">
        <button id="card-share-close" class="card-share-close">‚úï</button>
        <div class="card-share-title">Condividi la tua carta</div>
      </div>

      <div class="card-share-preview-wrap">
        <img id="card-share-preview" class="card-share-preview" alt="La tua carta dell'Oracolo del Rock">
      </div>

      <div class="card-share-actions">
        <button class="share-btn" id="btn-download-card">üì• Scarica</button>
        <button class="share-btn" id="btn-share-card-image">‚úçÔ∏è Condividi</button>
      </div>
    </div>
  </div>

  <!-- GENERATORE NASCOSTO PER LA CARTA -->
  <div class="share-card-generator">
    <div class="card-wrapper" id="share-card-wrapper">
      <img src="card-template.png" alt="Carta Oracolo del Rock">
      <div class="card-text" id="share-card-text"></div>
      <div class="card-number" id="share-card-number"></div>
    </div>
  </div>

  <!-- CARTE (solo dati) -->
  <script src="cards.js"></script>
  <!-- html2canvas per generare l'immagine -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    const API_KEY     = "AIzaSyDNsQKEvKwHOyZCJ0mojJS325Sbw6wX9as";
    const PLAYLIST_ID = "PL5l5Dspe3Obumt-dqGDVzM4bHp5Qc_vVx";
    const PAGE_SIZE   = 50;

    let player = null;
    let allIds = [];
    let currentVideoId = null;
    let entranceTimer = null;
    let outroInterval = null;
    let outroTriggered = false;
    let textTimer = null;
    let lastCardForShare = null;
    let lastCardIndexForShare = null;

    // per la condivisione immagine
    let lastCardImageBlob = null;
    let lastCardImageUrl  = null;
    let lastCardFileName  = "oracolo-risposta-000.png";

    // FORMATTA IL TESTO STILE BIG
    function formatOracleText(testo){
      if(!testo) return "";

      const words = testo.trim().split(/\s+/);

      return words.map(word => {
        const first = word.charAt(0).toUpperCase();
        const rest  = word.slice(1);
        return `<span class="word"><span class="big-init">${first}</span>${rest}</span>`;
      }).join(" ");
    }

    // MOSTRA / NASCONDE IL TESTO NELLA CABINA
    function mostraTestoNellaCabina(testo, delayMs = 0){
      const box = document.getElementById("oracle-text");
      if(!box) return;

      if (textTimer){
        clearTimeout(textTimer);
        textTimer = null;
      }

      if(!testo){
        box.classList.remove("visible");
        box.innerHTML = "";
        return;
      }

      box.classList.remove("visible");
      box.innerHTML = "";

      textTimer = setTimeout(() => {
        box.innerHTML = formatOracleText(testo);
        requestAnimationFrame(() => box.classList.add("visible"));
        textTimer = null;
      }, delayMs);
    }

    // carico API YouTube
    (function(){
      const s = document.createElement('script');
      s.src = "https://www.youtube.com/iframe_api";
      document.head.appendChild(s);
    })();

    window.onYouTubeIframeAPIReady = () => {
      player = new YT.Player('yt', {
        height: '390',
        width:  '640',
        playerVars: { modestbranding: 1, rel: 0 },
        events: {
          onReady: onReady,
          onStateChange: onStateChange
        }
      });
    };

    function onReady(){
      let btn     = document.getElementById("new");
      const heroImg = document.querySelector(".hero-img");

      const cleanBtn = btn.cloneNode(true);
      btn.parentNode.replaceChild(cleanBtn, btn);
      btn = cleanBtn;

      btn.classList.add("disabled");
      btn.textContent = "ACCENSIONE DELL'ORACOLO...";

      if(heroImg){
        heroImg.classList.add("activating");
      }

      btn.addEventListener("click", playRandom);

      boot();
    }

    async function boot(){
      try{
        allIds = await fetchAllPlaylistIds(PLAYLIST_ID);
      }catch(err){
        console.error(err);
        alert("Errore nel caricare la playlist.");
      }

      const btn     = document.getElementById("new");
      const heroImg = document.querySelector(".hero-img");

      btn.classList.remove("disabled");
      btn.textContent = "PESCA LA TUA CARTA";

      if(heroImg){
        heroImg.classList.remove("activating");
      }
    }

    async function fetchAllPlaylistIds(playlistId){
      let ids = [];
      let pageToken = "";

      do{
        const url = new URL("https://www.googleapis.com/youtube/v3/playlistItems");
        url.searchParams.set("key", API_KEY);
        url.searchParams.set("part", "snippet");
        url.searchParams.set("playlistId", playlistId);
        url.searchParams.set("maxResults", PAGE_SIZE);
        if(pageToken) url.searchParams.set("pageToken", pageToken);

        const res = await fetch(url.toString());
        if(!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        const batch = (data.items || [])
          .map(i => i?.snippet?.resourceId?.videoId)
          .filter(Boolean);

        ids.push(...batch);
        pageToken = data.nextPageToken || "";

      } while(pageToken);

      return [...new Set(ids)];
    }

    function playRandom(){
      const btn = document.getElementById("new");
      if(btn.classList.contains("disabled")) return;
      if(!player || !allIds.length) return;

      const ytBox = document.getElementById("yt");

      if(entranceTimer){
        clearTimeout(entranceTimer);
        entranceTimer = null;
      }
      if(textTimer){
        clearTimeout(textTimer);
        textTimer = null;
      }

      clearOutroWatcher();
      outroTriggered = false;

      ytBox.classList.remove("is-hidden");
      ytBox.classList.add("is-visible");
      ytBox.classList.add("audio-first");

      let idsPool = allIds;
      if (typeof cards !== "undefined" && Array.isArray(cards)){
        const validIds = new Set(
          cards
            .filter(c => c.videoId && c.videoId.trim() !== "")
            .map(c => c.videoId.trim())
        );
        const filtered = allIds.filter(id => validIds.has(id));
        if (filtered.length){
          idsPool = filtered;
        }
      }

      if (!idsPool.length){
        mostraTestoNellaCabina("");
        lastCardForShare = null;
        lastCardIndexForShare = null;
        return;
      }

      const idx = Math.floor(Math.random() * idsPool.length);
      const id  = idsPool[idx];

      currentVideoId = id;
      player.loadVideoById(id);

      mostraTestoNellaCabina("");

      if (typeof cards !== "undefined" && Array.isArray(cards)){
        const card = cards.find(c => (c.videoId || "").trim() === id);

        if (card && card.text){
          lastCardForShare = card;

          let n = null;
          if (typeof card.n === "number") {
            n = card.n;
          } else if (typeof card.id === "number") {
            n = card.id;
          } else {
            const pos = cards.indexOf(card);
            if (pos >= 0) n = pos + 1;
          }
          lastCardIndexForShare = n;

          mostraTestoNellaCabina(card.text, 7000);
        } else {
          lastCardForShare = null;
          lastCardIndexForShare = null;
        }
      }

      entranceTimer = setTimeout(() => {
        ytBox.classList.remove("audio-first");
        entranceTimer = null;
      }, 3000);
    }

    function onStateChange(e){
      const ytBox = document.getElementById("yt");

      if(e.data === YT.PlayerState.PLAYING){
        startOutroWatcher();
      }

      if(
        e.data === YT.PlayerState.PAUSED ||
        e.data === YT.PlayerState.BUFFERING
      ){
        clearOutroWatcher();
      }

      if(e.data === YT.PlayerState.ENDED){
        clearOutroWatcher();
        outroTriggered = false;

        if(entranceTimer){
          clearTimeout(entranceTimer);
          entranceTimer = null;
        }
        if(textTimer){
          clearTimeout(textTimer);
          textTimer = null;
        }

        ytBox.classList.remove("audio-first");
        ytBox.classList.remove("is-visible");
        ytBox.classList.add("is-hidden");

        mostraTestoNellaCabina("");
      }
    }

    function startOutroWatcher(){
      clearOutroWatcher();
      outroTriggered = false;

      outroInterval = setInterval(() => {
        if(!player || outroTriggered) return;

        const dur = player.getDuration();
        const cur = player.getCurrentTime();
        if(!dur || !cur) return;

        const remaining = dur - cur;

        if(remaining <= 1.0){
          outroTriggered = true;
          triggerOutro();
        }
      }, 250);
    }

    function clearOutroWatcher(){
      if(outroInterval){
        clearInterval(outroInterval);
        outroInterval = null;
      }
    }

    function triggerOutro(){
      const ytBox = document.getElementById("yt");

      ytBox.classList.remove("is-visible");
      ytBox.classList.add("is-hidden");

      setTimeout(() => {
        try{ player.stopVideo(); }catch(_){}
      }, 200);

      clearOutroWatcher();
    }

    // TASTO CONDIVIDI AUDIO
    const shareAudioBtn = document.getElementById("share-audio");

    if (shareAudioBtn) {
      shareAudioBtn.addEventListener("click", async () => {

        if (!currentVideoId) {
          alert("Prima pesca la tua carta!");
          return;
        }

        const videoUrl = `https://youtu.be/${currentVideoId}`;

        if (navigator.share) {
          try {
            await navigator.share({
              title: "Ascolta il brano che mi √® uscito dall'Oracolo del Rock!",
              text: "Ecco il mio responso musicale:",
              url: videoUrl
            });
            return;
          } catch (e) {
            console.log("Condivisione annullata", e);
          }
        }

        try {
          await navigator.clipboard.writeText(videoUrl);
          alert("Link copiato! Ora puoi incollarlo dove vuoi:\n\n" + videoUrl);
        } catch (e) {
          alert("Ecco il link da copiare:\n\n" + videoUrl);
        }
      });
    }

    // === FUNZIONE: genera PNG della carta usando il generatore nascosto ===
    async function generaPngCartaCondivisibile(){
      if (!lastCardForShare || !lastCardForShare.text){
        throw new Error("Nessuna carta da condividere");
      }

      const wrapper  = document.getElementById("share-card-wrapper");
      const textEl   = document.getElementById("share-card-text");
      const numEl    = document.getElementById("share-card-number");

      let n = lastCardIndexForShare;
      if (!n || isNaN(n)) n = 1;
      const padded = String(n).padStart(3,"0");
      lastCardFileName = "oracolo-risposta-" + padded + ".png";

      textEl.innerHTML = formatOracleText(lastCardForShare.text || "");
      numEl.textContent = "RISPOSTA N:" + padded;

      await new Promise(res => requestAnimationFrame(res));

      const canvas = await html2canvas(wrapper, {
        useCORS:true,
        backgroundColor:null,
        scale:2
      });

      return new Promise((resolve, reject) => {
        canvas.toBlob(blob => {
          if (!blob){
            reject(new Error("Blob nullo"));
            return;
          }

          if (lastCardImageUrl){
            URL.revokeObjectURL(lastCardImageUrl);
          }

          lastCardImageBlob = blob;
          lastCardImageUrl  = URL.createObjectURL(blob);

          resolve({
            blob:lastCardImageBlob,
            url:lastCardImageUrl,
            padded
          });
        }, "image/png");
      });
    }

    // TASTO ‚úçÔ∏è CONDIVIDI CARTA ‚Üí APRE OVERLAY
    const shareCardBtn = document.getElementById("share-card");

    if (shareCardBtn) {
      shareCardBtn.addEventListener("click", async () => {

        if (!lastCardForShare || !lastCardForShare.text) {
          alert("Prima pesca la tua carta!");
          return;
        }

        const overlay = document.getElementById("card-share-overlay");
        const preview = document.getElementById("card-share-preview");

        try{
          const { url } = await generaPngCartaCondivisibile();
          preview.src = url;
          overlay.style.display = "flex";
        }catch(e){
          console.error(e);
          alert("Errore nella generazione della carta.");
        }
      });
    }

    // chiusura overlay
    const overlayEl   = document.getElementById("card-share-overlay");
    const overlayClose= document.getElementById("card-share-close");
    if (overlayClose && overlayEl){
      overlayClose.addEventListener("click", () => {
        overlayEl.style.display = "none";
      });

      overlayEl.addEventListener("click", (e) => {
        if (e.target === overlayEl){
          overlayEl.style.display = "none";
        }
      });
    }

    // pulsante SCARICA
    const btnDownload = document.getElementById("btn-download-card");
    if (btnDownload){
      btnDownload.addEventListener("click", () => {
        if (!lastCardImageUrl){
          alert("Nessuna immagine da scaricare.");
          return;
        }
        const a = document.createElement("a");
        a.href = lastCardImageUrl;
        a.download = lastCardFileName || "oracolo-del-rock.png";
        document.body.appendChild(a);
        a.click();
        a.remove();
      });
    }

    // pulsante CONDIVIDI IMMAGINE
    const btnShareImg = document.getElementById("btn-share-card-image");
    if (btnShareImg){
      btnShareImg.addEventListener("click", async () => {
        if (!lastCardImageBlob){
          alert("Nessuna immagine da condividere.");
          return;
        }

        const file = new File(
          [lastCardImageBlob],
          lastCardFileName || "oracolo-del-rock.png",
          { type:"image/png" }
        );

        const shareData = {
          files:[file],
          title:"Chiedilo all‚ÄôOracolo del Rock",
          text:lastCardForShare?.text || "La mia carta dell'Oracolo del Rock"
        };

        if (navigator.canShare && navigator.canShare({ files:[file] })){
          try{
            await navigator.share(shareData);
          }catch(e){
            console.log("Condivisione annullata", e);
          }
        }else{
          alert("La condivisione diretta dell'immagine non √® supportata su questo dispositivo. Puoi comunque usare il tasto 'Scarica' e condividerla manualmente.");
        }
      });
    }
  </script>

<!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "98a14e72a5814bd6a4f95216aca084d5"}'></script><!-- End Cloudflare Web Analytics -->

  
</body>
</html>










